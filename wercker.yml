# Base ruby image chokes on utf8 and doesn't have nodejs
box: phusion/passenger-ruby22
build:
    steps:
        - script:
            name: install bindeps
            code: |
                apt-get update
                apt-get install git zopfli -y
        - add-to-known_hosts:
            hostname: github.com
            fingerprint: 16:27:ac:a5:76:28:2d:36:63:1b:56:4d:eb:df:a6:48
        - script:
            name: initialize git submodules
            code: |
                git submodule update --init --recursive
        - script:
            name: update npm
            code: |
                npm update -g npm
        - bundle-install
        - npm-install
        - grunt
    after-steps:
        - wantedly/pretty-slack-notify:
            webhook_url: $SLACK_WEBHOOK_URL
deploy:
    steps:
        - mktemp:
            envvar: PRIVATEKEY_PATH
        - create-file:
            name: write key
            filename: $PRIVATEKEY_PATH
            content: $DEPLOY_KEY_PRIVATE
            overwrite: true
            hide-from-log: true
        - script:
            name: knock on door
            code: |
                IFS=' ' read -r -a PORTS <<< "$KNOCK_PORTS"
                for PORT in "${PORTS[@]}" ; do nmap -Pn --host_timeout 100 --max-retries 0 -p $PORT $DEPLOY_HOST ; done
        - add-to-known_hosts:
            hostname: foray-jero.me
            fingerprint: AAAAC3NzaC1lZDI1NTE5AAAAIM9hMCArQf8PcLl6c6Yqo1O/QnAk+fHefgBWCZG6Yc4c
        - fedor/rsync-soft-deploy:
            host: $DEPLOY_HOST
            user: $DEPLOY_USER
            sshkey: $PRIVATEKEY_PATH
            directory: $DEPLOY_DIRECTORY
            source: _site
    after-steps:
        - wantedly/pretty-slack-notify:
            webhook_url: $SLACK_WEBHOOK_URL